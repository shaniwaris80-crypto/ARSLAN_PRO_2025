<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ARSLAN LISTAS v4.1 ‚Äî KIWI MASTER EDITION (Auto-Sync Supabase)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<style>
  :root{
    --ink:#111827; --muted:#6b7280; --kiwi:#16a34a; --kiwi-2:#15803d; --border:#e5e7eb; --bg:#ffffff; --panel:#f8fafc;
    --bad:#dc2626; --ok:#166534; --okbg:#ecfdf5; --warnbg:#fee2e2; --warn:#991b1b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{font-family:'Poppins',sans-serif;background:var(--bg);color:var(--ink);margin:0}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:10}
  .wrap{max-width:1200px;margin:0 auto;padding:12px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand svg{width:36px;height:36px}
  .brand h1{font-size:18px;margin:0}
  .tabs{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
  .tab-btn{padding:8px 12px;border:1px solid var(--kiwi);border-radius:999px;background:#fff;color:var(--kiwi);cursor:pointer;font-size:13px}
  .tab-btn.active{background:linear-gradient(135deg,var(--kiwi),var(--kiwi-2));color:#fff}
  main{max-width:1200px;margin:0 auto;padding:14px}
  .grid-3{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:980px){.grid-3{grid-template-columns:repeat(3,1fr)}}
  .card{border:1px solid var(--border);border-radius:14px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.05)}
  .card .hd{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border)}
  .card .bd{padding:12px}
  textarea{width:100%;min-height:120px;border:1px solid var(--border);border-radius:12px;padding:10px;resize:vertical}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left;font-size:14px;vertical-align:top}
  th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--kiwi);background:linear-gradient(135deg,var(--kiwi),var(--kiwi-2));color:#fff;cursor:pointer;font-size:14px}
  .btn.ghost{background:#fff;color:var(--kiwi);border:1px solid var(--kiwi)}
  .btn.muted{background:#fff;border:1px solid var(--border);color:var(--ink)}
  .btn.small{padding:4px 6px;font-size:12px}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--panel);font-size:12px;color:var(--muted)}
  .pill.ok{border-color:#bbf7d0;background:#ecfdf5;color:var(--ok)}
  .pill.warn{border-color:#fecaca;background:var(--warnbg);color:var(--warn)}
  .red{color:var(--bad);font-weight:700}
  .green{color:var(--ok);font-weight:700}
  tr.assigned td{background:#ecfdf5}
  .ac-box{position:absolute;background:#fff;border:1px solid var(--border);border-radius:8px;box-shadow:0 8px 16px rgba(0,0,0,.08);z-index:9999;overflow:hidden}
  .ac-item{padding:8px 10px;cursor:pointer;font-size:14px}
  .ac-item:hover{background:#f3f4f6}
  .prov-bar{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
  .prov-btn{padding:6px 10px;border-radius:10px;border:1px solid var(--kiwi);background:#fff;color:var(--kiwi);cursor:pointer;font-size:13px}
  .prov-btn.active{background:var(--kiwi);color:#fff}
  .hint{font-size:12px;color:var(--muted)}
  .row-ok-btn{margin-right:8px}
  .wa{display:inline-flex;align-items:center;gap:6px}
  .wa svg{width:18px;height:18px}
  .status{font-size:12px}
  .left-btn{min-width:42px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <svg viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg" aria-label="Kiwi Logo" role="img"><defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#22c55e"/><stop offset="1" stop-color="#16a34a"/></linearGradient></defs><circle cx="64" cy="64" r="58" fill="url(#g)" stroke="#15803d" stroke-width="4"/><circle cx="64" cy="64" r="12" fill="#111827"/><g stroke="#065f46" stroke-width="3"> <line x1="64" y1="22" x2="64" y2="40"/> <line x1="64" y1="86" x2="64" y2="106"/> <line x1="22" y1="64" x2="42" y2="64"/> <line x1="86" y1="64" x2="106" y2="64"/> <line x1="36" y1="36" x2="48" y2="48"/> <line x1="80" y1="80" x2="92" y2="92"/> <line x1="36" y1="92" x2="48" y2="80"/> <line x1="80" y1="48" x2="92" y2="36"/></g></svg>
      <h1>ARSLAN LISTAS v4.1 ‚Äî KIWI MASTER EDITION</h1>
      <span class="status" id="syncStatus">‚è≥ Conectando‚Ä¶</span>
    </div>
    <div class="tabs" id="tabs"></div>
  </div>
</header>
<main>
  <section class="card" data-tab="Vocabulario">
    <div class="hd">
      <strong>‚úîÔ∏è Vocabulario estandarizado global (auto-sync)</strong>
      <div class="toolbar">
        <input id="vSearch" class="btn muted" style="padding:8px 10px" placeholder="üîé Buscar en vocabulario" />
        <button class="btn ghost" id="btnAddVocab">A√±adir palabra</button>
        <button class="btn muted" id="btnReloadVocab">Recargar</button>
      </div>
    </div>
    <div class="bd">
      <div class="hint">Se normaliza a <b>MAY√öSCULAS</b> sin tildes. Se sincroniza para todos los dispositivos.</div>
      <textarea id="vocabTxt" placeholder="Una palabra por l√≠nea‚Ä¶"></textarea>
    </div>
  </section>

  <section class="grid-3" data-tab="Tiendas">
    <div class="card">
      <div class="hd"><strong>San Pablo</strong>
        <div class="toolbar">
          <button class="btn ghost" onclick="estandarizar('sp')">Estandarizar</button>
          <button class="btn muted" onclick="waTxtStore('sp')">WhatsApp TXT</button>
        </div>
      </div>
      <div class="bd">
        <textarea id="in_sp" placeholder="Pega lista San Pablo‚Ä¶
Ej.: 3 cajas tomate daniela
zanahoria 2
aguacate granel 4"></textarea>
        <div class="hint">Clica en el nombre o cantidad para corregir. Sugerencias al escribir. Coincidencias aproximadas se marcan en <span class="red">rojo</span>.</div>
        <div id="tbl_sp_wrap" style="margin-top:8px"></div>
      </div>
    </div>

    <div class="card">
      <div class="hd"><strong>San Lesmes</strong>
        <div class="toolbar">
          <button class="btn ghost" onclick="estandarizar('sl')">Estandarizar</button>
          <button class="btn muted" onclick="waTxtStore('sl')">WhatsApp TXT</button>
        </div>
      </div>
      <div class="bd">
        <textarea id="in_sl" placeholder="Pega lista San Lesmes‚Ä¶"></textarea>
        <div class="hint">Clica en el nombre o cantidad para corregir. Sugerencias al escribir. Coincidencias aproximadas se marcan en rojo.</div>
        <div id="tbl_sl_wrap" style="margin-top:8px"></div>
      </div>
    </div>

    <div class="card">
      <div class="hd"><strong>Santiago</strong>
        <div class="toolbar">
          <button class="btn ghost" onclick="estandarizar('st')">Estandarizar</button>
          <button class="btn muted" onclick="waTxtStore('st')">WhatsApp TXT</button>
        </div>
      </div>
      <div class="bd">
        <textarea id="in_st" placeholder="Pega lista Santiago‚Ä¶"></textarea>
        <div class="hint">Clica en el nombre o cantidad para corregir. Sugerencias al escribir. Coincidencias aproximadas se marcan en rojo.</div>
        <div id="tbl_st_wrap" style="margin-top:8px"></div>
      </div>
    </div>
  </section>

  <section class="card" data-tab="Global">
    <div class="hd">
      <strong>üßÆ Unificaci√≥n global</strong>
      <div class="toolbar">
        <button class="btn ghost" onclick="unificarGlobal()">Unificar 3 tiendas</button>
        <button class="btn muted" onclick="exportarGlobalTXT()">Exportar TXT</button>
        <button class="btn muted" onclick="exportarGlobalXLSX()">Exportar Excel</button>
        <button class="btn muted" onclick="copiarGlobal()">Copiar</button>
        <button class="btn" onclick="generarResumenTXT()">Resumen TXT (WA)</button>
      </div>
    </div>
    <div class="bd">
      <div class="hint">Productos muy parecidos se <b class="red">marcan en rojo</b> para revisi√≥n manual. Sugerencias al escribir.</div>
      <div id="global_wrap" style="margin-top:8px"></div>
    </div>
  </section>

  <section class="card" data-tab="Proveedores" style="margin-top:14px">
    <div class="hd">
      <strong>üì¶ Distribuci√≥n por proveedor</strong>
    </div>
    <div class="bd">
      <div class="prov-bar" id="provBar"></div>
      <div class="grid-3" id="provPanels" style="margin-top:8px"></div>
    </div>
  </section>

  <section class="card" data-tab="Compras & Reparto" style="margin-top:14px">
    <div class="hd"><strong>üßæ Compras y Reparto a tiendas</strong>
      <div class="toolbar">
        <button class="btn ghost" onclick="moverNoCompradosACompras()">Refrescar pendientes</button>
        <button class="btn muted" onclick="generarReparto()">Generar reparto por tienda</button>
      </div>
    </div>
    <div class="bd">
      <div class="grid-3">
        <div class="card">
          <div class="hd"><strong>Pendientes de comprar</strong></div>
          <div class="bd"><div id="pendientes_wrap" class="hint">Asigna productos en Global a un proveedor y marca ‚úÖ cuando los compres.</div></div>
        </div>
        <div class="card">
          <div class="hd"><strong>Comprados</strong></div>
          <div class="bd"><div id="comprados_wrap" class="hint">Aqu√≠ ver√°s lo marcado como ‚úÖ Comprado.</div></div>
        </div>
        <div class="card">
          <div class="hd"><strong>Reparto por tienda (solo comprados)</strong></div>
          <div class="bd"><div id="reparto_wrap" class="hint">Pulsa "Generar reparto" para ver por tienda.</div></div>
        </div>
      </div>
    </div>
  </section>

  <section class="card" data-tab="Terminar">
    <div class="hd"><strong>‚úÖ Terminar tarea</strong></div>
    <div class="bd">
      <p class="hint">Esto sincroniza todo y limpia: tiendas, global, asignados y compras. El vocabulario permanece.</p>
      <button class="btn" onclick="terminarTarea()">Terminar y Limpiar</button>
    </div>
  </section>
</main>

<script>
const SUPABASE_URL = 'https://esvfgvfqttvjcrsnxufq.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzdmZndmZxdHR2amNyc254dWZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNTIwNjIsImV4cCI6MjA3NzgyODA2Mn0.SdtgaK6c7gJAxA8jH77w0K3ctMlvGx6g4YLYrI0PKuw';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const STATUS = document.getElementById('syncStatus');

const TABS = ['Vocabulario','Tiendas','Global','Proveedores','Compras & Reparto','Terminar'];
const tabsEl = document.getElementById('tabs');
function buildTabs(){
  tabsEl.innerHTML='';
  TABS.forEach((t,i)=>{
    const b=document.createElement('button');
    b.className='tab-btn'+(i===1?' active':''); b.textContent=t; b.onclick=()=>activateTab(t);
    tabsEl.appendChild(b);
  });
  activateTab('Tiendas');
}
function activateTab(name){
  document.querySelectorAll('.tab-btn').forEach(btn=> btn.classList.toggle('active', btn.textContent===name));
  document.querySelectorAll('main > section').forEach(sec=> sec.style.display = (sec.dataset.tab===name || (!sec.dataset.tab && name==='Tiendas')) ? '' : 'none');
}

const PROVEEDORES = ["ESMO","MONTENEGRO","JOS√â ANTONIO","√ÅNGEL VACA","JAVI","ANGELO"];
const IGNORE_WORDS = ['caja','cajas','kg','kilo','kilos','uds','ud','u','unidad','unidades','manojo','manojos','saco','sacos'];
const $ = s => document.querySelector(s);
const byId = id => document.getElementById(id);
const toLines = t => String(t||'').split(/[

,]/).map(x=>x.trim()).filter(Boolean);
function removeDiacriticsUpper(s){ return String(s||'').normalize('NFD').replace(/[ÃÄ-ÕØ]/g,'').replace(/√±/g,'N').replace(/√ë/g,'N').toUpperCase(); }
function normKey(s){ return removeDiacriticsUpper(s).replace(/[^A-Z0-9\s]/g,' ').replace(/\s+/g,' ').trim(); }
function stripGenericWords(s){ const tokens = normKey(s).split(' ').filter(t=>!IGNORE_WORDS.includes(t.toLowerCase())); return tokens.join(' ').trim(); }
function bigrams(str){ const s = stripGenericWords(str); const arr=[]; for(let i=0;i<s.length-1;i++){ if(s[i]!==' '&&s[i+1]!==' ') arr.push(s.slice(i,i+2)); } return arr; }
function diceSim(a,b){ const A=bigrams(a), B=bigrams(b); if(!A.length||!B.length) return 0; let hits=0; const pool=B.slice(); A.forEach(bg=>{const idx=pool.indexOf(bg); if(idx>-1){hits++; pool.splice(idx,1);} }); return (2*hits)/(A.length+B.length); }
function bestMatch(query, vocabArr){ const q=stripGenericWords(query); let best={name:null,score:0}; vocabArr.forEach(v=>{ const sc=diceSim(q,v); if(sc>best.score) best={name:v,score:sc}; }); return best; }
function debounce(fn,ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); }; }

const tiendaState = { sp:[], sl:[], st:[] };
let vocabList = [];
let globalRows = [];
let assignments = {};
let orders = {};
let comprados = [];
let ACTIVE_PROV = PROVEEDORES[0];

const OFFICIAL_VOCAB = `
GRANNY FRANCIA
MANZANA PINK LADY
MANDARINA COLOMBE
KIWI ZESPRI GOLD
PARAGUAYO 
KIWI TOMASIN PLANCHA
PERA RINCON DEL SOTO
MELOCOTON PRIMERA
AGUACATE GRANEL
MARACUYA
MANZANA GOLDEN 24
PLATANO CANARIO PRIMERA
MANDARINA HOJA
MANZANA GOLDEN 20
NARANJA TOMASIN
NECTARINA
NUECES
SANDIA
LIMON SEGUNDA
MANZANA FUJI
NARANJA MESA SONRISA
JENGIBRE
BATATA
AJO PRIMERA
CEBOLLA NORMAL
CALABAZA GRANDE
PATATA LAVADA
TOMATE CHERRY RAMA
TOMATE CHERRY PERA
TOMATE DANIELA
TOMATE ROSA PRIMERA
CEBOLLINO
TOMATE ASURCADO MARRON
TOMATE RAMA
PIMIENTO PADRON
ZANAHORIA
PEPINO
CEBOLLETA
PUERROS
BROCOLI
JUDIA VERDE
BERENJENA
PIMIENTO ITALIANO VERDE
PIMIENTO ITALIANO ROJO
CHAMPINON
UVA ROJA
UVA BLANCA
ALCACHOFA
CALABACIN
COLIFLOR
BATAVIA
ICEBERG
MANDARINA SEGUNDA
MANZANA GOLDEN 28
NARANJA ZUMO
KIWI SEGUNDA
MANZANA ROYAL GALA 24
PLATANO CANARIO SUELTO
CEREZA 
FRESAS
ARANDANOS
ESPINACA
PEREJIL
CILANTRO
ACELGAS
PIMIENTO VERDE
PIMIENTO ROJO
MACHO VERDE
MACHO MADURO
YUCA
AVOCADO
CEBOLLA ROJA
MENTA
HABANERO
RABANITOS
POMELO
PAPAYA
REINETA 28
NISPERO
ALBARICOQUE
TOMATE PERA
TOMATE BOLA
TOMATE PINK
VALVENOSTA GOLDEN
MELOCOTON ROJO
MELON GALIA
APIO
NARANJA SANHUJA
LIMON PRIMERA
MANGO
MELOCOTON AMARILLO
VALVENOSTA ROJA
PI√ëA
NARANJA HOJA
PERA CONFERENCIA SEGUNDA
CEBOLLA DULCE
TOMATE ASURCADO AZUL
ESPARRAGOS BLANCOS
ESPARRAGOS TRIGUEROS
REINETA PRIMERA
AGUACATE PRIMERA
COCO
NECTARINA SEGUNDA
REINETA 24
NECTARINA CARNE BLANCA
GUINDILLA
REINETA VERDE
PATATA 25KG
PATATA 5 KG
TOMATE RAFF
REPOLLO
KIWI ZESPRI
PARAGUAYO SEGUNDA
MELON
REINETA 26
TOMATE ROSA
MANZANA CRIPS
ALOE VERA PIEZAS
TOMATE ENSALADA
PATATA 10KG
MELON BOLLO
CIRUELA ROJA
LIMA
GUINEO VERDE
SETAS
BANANA
BONIATO
FRAMBUESA
BREVAS
PERA AGUA
YAUTIA
YAME
OKRA
MANZANA MELASSI
CACAHUETE
SANDIA NEGRA
SANDIA RAYADA
HIGOS
KUMATO
KIWI CHILE
MELOCOTON AMARILLO SEGUNDA
HIERBABUENA
REMOLACHA
LECHUGA ROMANA
KAKI
CIRUELA CLAUDIA
PERA LIMONERA
CIRUELA AMARILLA
HIGOS BLANCOS
UVA ALVILLO
LIMON EXTRA
PITAHAYA ROJA
HIGO CHUMBO
CLEMENTINA
GRANADA
NECTARINA PRIMERA BIS
CHIRIMOYA
UVA CHELVA
PIMIENTO CALIFORNIA VERDE
KIWI TOMASIN  
PIMIENTO CALIFORNIA ROJO
MANDARINA SATSUMA
CASTA√ëA
CAKI
MANZANA KANZI
PERA ERCOLINA
NABO
UVA ALVILLO NEGRA
CHAYOTE
ROYAL GALA 28
MANDARINA PRIMERA
PIMIENTO PINTON
MELOCOTON AMARILLO DE CALANDA
HINOJOS
MANDARINA DE HOJA
UVA ROJA PRIMERA
UVA BLANCA PRIMERA
`;

async function sbReady(){
  try{
    STATUS.textContent='üîÑ Sincronizando‚Ä¶';
    await Promise.all([loadVocabFromSB(), loadStoresFromSB(), loadAssignmentsFromSB(), loadOrdersFromSB(), loadCompradosFromSB()]);
    STATUS.textContent='‚úÖ Conectado';
  }catch(e){
    console.warn(e);
    if (!vocabList.length) { vocabList = uniqueVocab(toLines(OFFICIAL_VOCAB)); byId('vocabTxt').value = vocabList.join('\n'); }
    STATUS.textContent='‚ö†Ô∏è Offline (se guarda local y sincroniza luego)';
  }
}
async function loadVocabFromSB(){
  const { data, error } = await sb.from('vocabulario').select('term');
  if(error){
    console.warn('vocab load',error);
    vocabList = uniqueVocab(toLines(OFFICIAL_VOCAB));
    byId('vocabTxt').value = vocabList.join('\n');
    return;
  }
  const raw = (data||[]).map(r=>removeDiacriticsUpper(r.term));
  if (!raw.length) {
    vocabList = uniqueVocab(toLines(OFFICIAL_VOCAB));
    byId('vocabTxt').value = vocabList.join('\n');
    const rows = vocabList.map(t=>({term:t}));
    await sb.from('vocabulario').upsert(rows, { onConflict:'term' });
  } else {
    vocabList = uniqueVocab(raw);
    byId('vocabTxt').value = vocabList.join('\n');
  }
}
const saveVocabSB = debounce(async function(){
  try{
    const rows = uniqueVocab(toLines(byId('vocabTxt').value)).map(t=>({term:t}));
    vocabList = rows.map(r=>r.term);
    if(rows.length){ await sb.from('vocabulario').upsert(rows, {onConflict:'term'}); }
    const { data:all } = await sb.from('vocabulario').select('term');
    const toDel = (all||[]).filter(x=>!vocabList.includes(removeDiacriticsUpper(x.term)));
    if(toDel.length){ await sb.from('vocabulario').delete().in('term', toDel.map(x=>x.term)); }
  }catch(e){ console.warn('vocab save',e); }
}, 600);
function uniqueVocab(lines){ const seen=new Set(); const out=[]; for(const l of lines){ const t=removeDiacriticsUpper(l).trim(); if(!t) continue; const k=normKey(t); if(!seen.has(k)){ seen.add(k); out.push(t); } } return out; }

async function loadStoresFromSB(){ const { data, error } = await sb.from('tiendas').select('tienda, rows'); if(error){ console.warn('stores load',error); return; } (data||[]).forEach(r=>{ if(['sp','sl','st'].includes(r.tienda) && Array.isArray(r.rows)) tiendaState[r.tienda]=r.rows; }); ['sp','sl','st'].forEach(renderTable); }
const saveStoreSB = debounce(async function(code){ try{ const rows=tiendaState[code]||[]; await sb.from('tiendas').upsert({tienda:code, rows},{onConflict:'tienda'}); }catch(e){ console.warn('store save',code,e); } }, 500);

async function loadAssignmentsFromSB(){ const { data, error } = await sb.from('asignados').select('key, proveedor'); if(error){ console.warn('assign load',error); return; } assignments={}; (data||[]).forEach(r=> assignments[r.key]=r.proveedor); }
async function saveAssignmentSB(key, prov){ try{ await sb.from('asignados').upsert({key,proveedor:prov},{onConflict:'key'}); }catch(e){ console.warn('assign save',e); } }
async function loadOrdersFromSB(){ const { data, error } = await sb.from('pedidos').select('proveedor, items'); if(error){ console.warn('orders load',error); return; } orders={}; PROVEEDORES.forEach(p=>orders[p]=[]); (data||[]).forEach(r=>{ orders[r.proveedor]=Array.isArray(r.items)?r.items:[]; }); renderProvidersPanels(); }
const saveOrdersSB = debounce(async function(prov){ try{ await sb.from('pedidos').upsert({proveedor:prov, items:orders[prov]||[]},{onConflict:'proveedor'}); } catch(e){ console.warn('orders save',prov,e); } }, 500);

async function loadCompradosFromSB(){ const { data, error } = await sb.from('comprados').select('items'); if(error){ console.warn('comprados load',error); return; } comprados = (data && data[0] && Array.isArray(data[0].items)) ? data[0].items : []; renderCompras(); }
const saveCompradosSB = debounce(async function(){ try{ await sb.from('comprados').upsert({id:1, items:comprados},{onConflict:'id'}); } catch(e){ console.warn('comprados save',e); } }, 600);

let AC_ACTIVE = null;
function closeAC(){ if(AC_ACTIVE){ AC_ACTIVE.remove(); AC_ACTIVE=null; } }
function attachAutocomplete(cell, onPick){
  cell.addEventListener('input', ()=>{
    const val = stripGenericWords(cell.innerText||''); closeAC(); if(!val) return;
    const suggestions = vocabList.filter(v=> normKey(v).includes(normKey(val))).slice(0,8);
    if(!suggestions.length) return;
    const rect = cell.getBoundingClientRect();
    const box = document.createElement('div'); box.className='ac-box';
    box.style.left = (rect.left + window.scrollX) + 'px'; box.style.top = (rect.bottom + window.scrollY) + 'px'; box.style.width = rect.width + 'px';
    suggestions.forEach(s=>{ const item=document.createElement('div'); item.className='ac-item'; item.textContent=s; item.onclick=()=>{ onPick(s); closeAC(); }; box.appendChild(item); });
    document.body.appendChild(box); AC_ACTIVE=box;
  });
  document.addEventListener('click', (e)=>{ if(AC_ACTIVE && !AC_ACTIVE.contains(e.target) && e.target!==cell){ closeAC(); } }, {capture:true});
}

function parseLine(raw){
  if(!raw) return null;
  let s = raw.replace(/\t/g,' ').replace(/\s{2,}/g,' ').trim(); s = s.replace(/^[\-‚Ä¢*]\s*/,'');
  let qty=null, name=s;
  const mX = s.match(/(?:x|X|\*)\s*(\d+[\.,]?\d*)\b/); if(mX){ qty=Number(mX[1].replace(',','.')); name=s.replace(mX[0],'').trim(); }
  if(qty===null){ const mEnd=s.match(/(\d+[\.,]?\d*)\s*(?:kg|kgs|kilo|kilos|uds|ud|u|unidad|unidades|caja|cajas)?\s*$/i); if(mEnd){ qty=Number(mEnd[1].replace(',','.')); name=s.slice(0,mEnd.index).trim(); } }
  if(qty===null){ const mStart=s.match(/^\s*(\d+[\.,]?\d*)\s+(.*)$/); if(mStart){ qty=Number(mStart[1].replace(',','.')); name=mStart[2].trim(); } }
  if(qty===null){ qty=1; }
  name = stripGenericWords(name);
  return { original: removeDiacriticsUpper(s), name, qty };
}

function renderTable(code){
  const wrap = byId('tbl_'+code+'_wrap'); const rows = tiendaState[code]||[]; if(!rows.length){ wrap.innerHTML=''; return; }
  let html = '<table><thead><tr><th class="left-btn">OK</th><th>Original</th><th>Estandarizado</th><th>Cantidad</th><th>Estado</th></tr></thead><tbody>';
  rows.forEach((r,i)=>{
    html += `<tr>
      <td><button class="btn small ghost row-ok-btn" onclick="filaOk('${code}',${i})">OK</button></td>
      <td>${r.o}</td>
      <td contenteditable="true" data-i="${i}" data-f="e" ${r.a? 'class="red"':''}>${r.e}</td>
      <td contenteditable="true" data-i="${i}" data-f="q">${r.q}</td>
      <td>${r.a? '<span class="pill warn">Revisar</span>':'<span class="pill ok">OK</span>'}</td>
    </tr>`;
  });
  html += '</tbody></table>'; wrap.innerHTML = html;
  wrap.querySelectorAll('td[contenteditable]').forEach(cell=>{
    const i=Number(cell.dataset.i); const f=cell.dataset.f;
    if(f==='e'){ attachAutocomplete(cell, picked=>{ cell.innerText=picked; tiendaState[code][i].e=picked; tiendaState[code][i].a=false; cell.classList.remove('red'); cell.parentElement.querySelector('td:last-child').innerHTML='<span class="pill ok">OK</span>'; saveStoreSB(code); }); }
    cell.addEventListener('blur', ()=>{
      const val=cell.innerText.trim();
      if(f==='q'){ tiendaState[code][i].q = Number(String(val).replace(',','.'))||0; }
      else{ const cleaned=removeDiacriticsUpper(val); tiendaState[code][i].e=cleaned; const exact=vocabList.find(v=> normKey(v)===normKey(cleaned)); const tdState=cell.parentElement.querySelector('td:last-child'); if(exact){ tiendaState[code][i].a=false; cell.classList.remove('red'); tdState.innerHTML='<span class="pill ok">OK</span>'; } else { tiendaState[code][i].a=true; cell.classList.add('red'); tdState.innerHTML='<span class="pill warn">Revisar</span>'; } }
      saveStoreSB(code);
    });
  });
}
function filaOk(code,i){ tiendaState[code][i].a=false; renderTable(code); saveStoreSB(code); }
function estandarizar(code){
  const txt = byId('in_'+code).value; const rows=[];
  toLines(txt).forEach(line=>{
    const p=parseLine(line); if(!p) return;
    const exact = vocabList.find(v=> normKey(v)===normKey(p.name));
    if(exact){ rows.push({o:p.original, e:exact, q:p.qty, a:false}); }
    else { const m=bestMatch(p.name, vocabList); const chosen=m.name||p.name; rows.push({o:p.original, e:chosen, q:p.qty, a:true}); }
  });
  tiendaState[code]=rows; renderTable(code); saveStoreSB(code);
}
function waTxtStore(code){ const rows=tiendaState[code]||[]; if(!rows.length){ alert('No hay filas estandarizadas.'); return; } const txt = rows.map(r=>`${r.q}\t${r.e}${r.a?'  *REVISAR*':''}`).join('\n'); const url='https://wa.me/?text='+encodeURIComponent(txt); window.open(url,'_blank'); }

function unificarGlobal(){
  const all = [].concat(tiendaState.sp||[], tiendaState.sl||[], tiendaState.st||[]);
  const map = new Map();
  all.forEach(r=>{ const key=normKey(r.e); if(!map.has(key)) map.set(key,{name:r.e,total:0}); map.get(key).total += (Number(r.q)||0); });
  const arr = Array.from(map.values()).sort((a,b)=>a.name.localeCompare(b.name,'es'));
  const names = arr.map(x=>x.name); const similarSet = new Set();
  for(let i=0;i<names.length;i++){ for(let j=i+1;j<names.length;j++){ const s1=names[i], s2=names[j]; const sim=diceSim(s1,s2); if(sim>=0.9 && normKey(s1)!==normKey(s2)){ similarSet.add(s1); similarSet.add(s2); } } }
  renderGlobalTable(arr, similarSet);
}
function renderGlobalTable(rows, similarSet){
  const visible = rows.filter(r => !assignments[normKey(r.name)]);
  globalRows = visible;
  const wrap = byId('global_wrap'); if(!visible.length){ wrap.innerHTML='<div class="hint">Sin productos (todo asignado o no unificado).</div>'; return; }
  let html = `<div class="hint" style="margin-bottom:6px">Proveedor activo: <b>${ACTIVE_PROV}</b>.</div>
    <table><thead><tr><th class="left-btn">‚û°Ô∏è</th><th>Producto</th><th>Total</th><th>Estado</th></tr></thead><tbody>`;
  visible.forEach((r,i)=>{
    const isSimilar = similarSet.has(r.name);
    html += `<tr data-i="${i}">
      <td><button class="btn small ghost" onclick="assignRow(${i})">‚û°Ô∏è</button></td>
      <td contenteditable="true" data-f="name" ${isSimilar? 'class="red"':''}>${r.name}</td>
      <td contenteditable="true" data-f="total">${r.total}</td>
      <td>${isSimilar? '<span class="pill warn">Posible duplicado</span>':'<span class="pill">OK</span>'}</td>
    </tr>`;
  }); html += '</tbody></table>'; wrap.innerHTML = html;
  wrap.querySelectorAll('td[contenteditable]').forEach(cell=>{
    const tr=cell.parentElement; const idx=Number(tr.dataset.i); const f=cell.dataset.f;
    if(f==='name') attachAutocomplete(cell, picked=>{ cell.innerText=picked; globalRows[idx].name=picked; cell.classList.remove('red'); tr.querySelector('td:last-child').innerHTML='<span class="pill">OK</span>'; });
    cell.addEventListener('blur', ()=>{
      const val=cell.innerText.trim(); if(f==='total'){ globalRows[idx].total = Number(String(val).replace(',','.'))||0; }
      else{ const cleaned=removeDiacriticsUpper(val); globalRows[idx].name=cleaned; const exact=vocabList.find(v=> normKey(v)===normKey(cleaned)); if(exact){ cell.classList.remove('red'); tr.querySelector('td:last-child').innerHTML='<span class="pill">OK</span>'; } else { cell.classList.add('red'); tr.querySelector('td:last-child').innerHTML='<span class="pill warn">Revisar</span>'; } }
    });
  });
}
async function assignRow(idx){
  const item=globalRows[idx]; if(!item) return;
  const k=normKey(item.name);
  assignments[k]=ACTIVE_PROV; await saveAssignmentSB(k, ACTIVE_PROV);
  const list=orders[ACTIVE_PROV]||[]; const exIdx=list.findIndex(x=> normKey(x.name)===k);
  if(exIdx>-1){ list[exIdx].qty += Number(item.total)||0; } else { list.push({name:item.name, qty:Number(item.total)||0, comprado:false}); }
  orders[ACTIVE_PROV]=list; saveOrdersSB(ACTIVE_PROV);
  unificarGlobal(); renderProvidersPanels(); renderCompras();
}

function buildProvBar(){
  const bar = byId('provBar'); bar.innerHTML='';
  PROVEEDORES.forEach(p=>{
    const b=document.createElement('button'); b.className='prov-btn'+(p===ACTIVE_PROV?' active':''); b.textContent=p;
    b.onclick=()=>{ ACTIVE_PROV=p; buildProvBar(); unificarGlobal(); };
    bar.appendChild(b);
  });
}
function renderProvidersPanels(){
  const cont = byId('provPanels'); cont.innerHTML='';
  PROVEEDORES.forEach(p=>{
    const list = orders[p]||[]; const card=document.createElement('div'); card.className='card';
    const hd=document.createElement('div'); hd.className='hd';
    hd.innerHTML = `<strong>${p}</strong>
      <div class="toolbar">
        <button class="btn small" onclick="exportProvTXT('${p}')">üìÑ TXT</button>
        <button class="btn small muted" onclick="waProv('${p}')">WhatsApp</button>
      </div>`;
    const bd=document.createElement('div'); bd.className='bd';
    if(!list.length){ bd.innerHTML='<div class="hint">Sin productos asignados.</div>'; }
    else{
      let html='<table><thead><tr><th></th><th>Producto</th><th>Cantidad</th><th>Estado</th></tr></thead><tbody>';
      list.forEach((it,ix)=>{
        html += `<tr>
          <td><button class="btn small ghost" onclick="toggleComprado('${p}',${ix})">${it.comprado?'‚úîÔ∏è':'‚óã'}</button></td>
          <td contenteditable="true" data-prov="${p}" data-idx="${ix}" data-f="name" class="green">${it.name}</td>
          <td contenteditable="true" data-prov="${p}" data-idx="${ix}" data-f="qty" class="green">${it.qty}</td>
          <td>${it.comprado?'<span class="pill ok">Comprado</span>':'<span class="pill">Pendiente</span>'}</td>
        </tr>`;
      });
      html+='</tbody></table>'; bd.innerHTML=html;
      bd.querySelectorAll('td[contenteditable]').forEach(cell=>{
        const prov=cell.dataset.prov; const idx=Number(cell.dataset.idx); const f=cell.dataset.f;
        if(f==='name') attachAutocomplete(cell, picked=>{ cell.innerText=picked; orders[prov][idx].name=picked; saveOrdersSB(prov); });
        cell.addEventListener('blur', ()=>{
          const val=cell.innerText.trim();
          if(f==='qty'){ orders[prov][idx].qty = Number(String(val).replace(',','.'))||0; }
          else { orders[prov][idx].name = removeDiacriticsUpper(val); }
          saveOrdersSB(prov);
        });
      });
    }
    card.appendChild(hd); card.appendChild(bd); cont.appendChild(card);
  });
}
function toggleComprado(prov, idx){
  const it = orders[prov][idx]; it.comprado = !it.comprado;
  if(it.comprado){
    comprados.push({name:it.name, qty:it.qty, prov}); saveCompradosSB();
  }else{
    const k=normKey(it.name);
    const pos=comprados.findIndex(x=> normKey(x.name)===k && x.prov===prov && Number(x.qty)===Number(it.qty));
    if(pos>-1){ comprados.splice(pos,1); saveCompradosSB(); }
  }
  saveOrdersSB(prov); renderProvidersPanels(); renderCompras();
}
function waProv(prov){ const list=(orders[prov]||[]).map(x=>`${x.qty}\t${x.name}${x.comprado?'  ‚úîÔ∏è':''}`).join('\n'); if(!list){ alert('Sin l√≠neas.'); return; } const url='https://wa.me/?text='+encodeURIComponent(list); window.open(url,'_blank'); }
function exportProvTXT(prov){ const list=orders[prov]||[]; if(!list.length){ alert('No hay l√≠neas para '+prov); return; } const today=new Date().toISOString().split('T')[0]; const txt=list.map(x=> `${x.qty}\t${x.name}${x.comprado?'\tCOMPRADO':''}`).join('\n'); const blob=new Blob([txt],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`pedido_${prov}_${today}.txt`; a.click(); }

function renderCompras(){
  const pend=[]; PROVEEDORES.forEach(p=> (orders[p]||[]).forEach(it=>{ if(!it.comprado) pend.push({prov:p, ...it}); }));
  const pendEl=byId('pendientes_wrap'); if(!pend.length){ pendEl.innerHTML='<div class="hint">No hay pendientes.</div>'; } else { let html='<table><thead><tr><th>Prov</th><th>Producto</th><th>Cantidad</th></tr></thead><tbody>'; pend.forEach(x=>{ html+=`<tr><td>${x.prov}</td><td>${x.name}</td><td>${x.qty}</td></tr>`; }); html+='</tbody></table>'; pendEl.innerHTML=html; }
  const compEl=byId('comprados_wrap'); if(!comprados.length){ compEl.innerHTML='<div class="hint">Sin compras.</div>'; } else { let html='<table><thead><tr><th>Prov</th><th>Producto</th><th>Cantidad</th></tr></thead><tbody>'; comprados.forEach(x=>{ html+=`<tr><td>${x.prov}</td><td>${x.name}</td><td>${x.qty}</td></tr>`; }); html+='</tbody></table>'; compEl.innerHTML=html; }
}
function moverNoCompradosACompras(){ renderCompras(); alert('Pendientes actualizados. Marca ‚úîÔ∏è en Proveedores para mover a Comprados.'); }
function generarReparto(){
  const map = new Map();
  comprados.forEach(x=>{ const k=normKey(x.name); if(!map.has(k)) map.set(k,{name:x.name,total:0}); map.get(k).total += Number(x.qty)||0; });
  let html = '<table><thead><tr><th>Producto</th><th>Total Comprado</th></tr></thead><tbody>';
  Array.from(map.values()).forEach(r=>{ html += `<tr><td>${r.name}</td><td>${r.total}</td></tr>`; });
  html += '</tbody></table>';
  byId('reparto_wrap').innerHTML = html;
}

function copiarGlobal(){ if(!globalRows.length) return; const txt = globalRows.map(r=>`- ${r.total} ${r.name}`).join('\n'); navigator.clipboard.writeText(txt); alert('Lista global copiada.'); }
function exportarGlobalTXT(){ if(!globalRows.length){ alert('No hay datos.'); return; } const today=new Date().toISOString().split('T')[0]; const txt=globalRows.map(r=>`${r.total}\t${r.name}`).join('\n'); const blob=new Blob([txt],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`lista_global_${today}.txt`; a.click(); }
function exportarGlobalXLSX(){ if(!globalRows.length){ alert('No hay datos.'); return; } const today=new Date().toISOString().split('T')[0]; const wb=XLSX.utils.book_new(); const ws=XLSX.utils.aoa_to_sheet([["Producto","Total"], ...globalRows.map(r=>[r.name,r.total])]); XLSX.utils.book_append_sheet(wb, ws, 'Global'); XLSX.writeFile(wb, `lista_global_${today}.xlsx`); }
function generarResumenTXT(){
  const pend=[]; PROVEEDORES.forEach(p=> (orders[p]||[]).forEach(x=>{ if(!x.comprado) pend.push({prov:p,...x}); }));
  const asig=PROVEEDORES.map(p=>`\n[${p}]\n` + ( (orders[p]||[]).map(x=> `${x.qty}\t${x.name}${x.comprado?'\tCOMPRADO':''}`).join('\n') || '‚Äî' ));
  const txt = `[PENDIENTES]\n` + (pend.map(x=> `${x.prov}\t${x.qty}\t${x.name}`).join('\n')||'‚Äî') + `\n\n[ASIGNADOS POR PROVEEDOR]\n` + asig.join('\n');
  const url = 'https://wa.me/?text='+encodeURIComponent(txt); window.open(url,'_blank');
}

async function terminarTarea(){
  if(!confirm('Esto limpiar√° tiendas, global, asignados y compras (el vocabulario se mantiene). ¬øContinuar?')) return;
  try{
    tiendaState.sp=[]; tiendaState.sl=[]; tiendaState.st=[];
    await sb.from('tiendas').delete().in('tienda',['sp','sl','st']);
    ['sp','sl','st'].forEach(renderTable);

    assignments={}; await sb.from('asignados').delete().neq('key','__none__');

    orders={}; PROVEEDORES.forEach(p=>orders[p]=[]); await sb.from('pedidos').delete().neq('proveedor','__none__');
    comprados=[]; await sb.from('comprados').upsert({id:1, items:[]},{onConflict:'id'});

    byId('global_wrap').innerHTML=''; buildProvBar(); renderProvidersPanels(); renderCompras();
    alert('Tarea finalizada y sincronizada.');
  }catch(e){ console.warn(e); alert('Se limpi√≥ localmente, pero hubo errores al sincronizar.'); }
}

function bindVocabUI(){
  byId('vocabTxt').addEventListener('input', saveVocabSB);
  byId('btnAddVocab').onclick = ()=>{
    const w = prompt('Nueva palabra:'); if(!w) return;
    const t=removeDiacriticsUpper(w);
    const list=uniqueVocab([...(toLines(byId('vocabTxt').value)), t]);
    byId('vocabTxt').value=list.join('\n'); saveVocabSB();
  };
  byId('btnReloadVocab').onclick = ()=> loadVocabFromSB();
  byId('vSearch').addEventListener('input', ()=>{
    const q = normKey(byId('vSearch').value); if(!q){ byId('vocabTxt').value=vocabList.join('\n'); return; }
    const filtered = vocabList.filter(v=> normKey(v).includes(q)); byId('vocabTxt').value = filtered.join('\n');
  });
}

(function init(){
  STATUS.textContent='‚è≥ Conectando‚Ä¶';
  buildTabs(); bindVocabUI(); sbReady(); buildProvBar(); renderProvidersPanels(); renderCompras();
})();
</script>
</body>
</html>
