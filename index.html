<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ARSLAN LISTAS v3.8 ‚Äî KIWI MOBILE + SUPABASE + LOGO</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Supabase JS v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --ink:#111827; --muted:#6b7280; --kiwi:#16a34a; --kiwi-2:#15803d; --border:#e5e7eb; --panel:#f8fafc;
    --bad:#dc2626; --ok:#16a34a; --warn:#f59e0b; --bg:#ffffff;
  }
  *{box-sizing:border-box}
  body{font-family:'Poppins',sans-serif;color:var(--ink);background:#fff;margin:0}
  h1{font-size:18px;margin:0;color:var(--ink)}
  .container{padding:12px 12px 76px}
  .hint{font-size:12px;color:var(--muted)}
  .card{border:1px solid var(--border);border-radius:14px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-bottom:12px}
  .card .hd{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border)}
  .card .bd{padding:10px 12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--kiwi);background:linear-gradient(135deg,var(--kiwi) 0%, var(--kiwi-2) 100%);color:#fff;cursor:pointer;font-size:14px}
  .btn.ghost{background:#fff;color:var(--kiwi);border:1px solid var(--kiwi)}
  .btn.muted{background:#fff;border:1px solid var(--border);color:var(--ink)}
  .btn.small{padding:6px 10px;font-size:13px}
  textarea{width:100%;min-height:120px;border:1px solid var(--border);border-radius:12px;padding:10px;resize:vertical;font-size:14px}
  input[type="text"], input[type="number"], select{border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:14px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left;font-size:14px;vertical-align:top}
  th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em;position:sticky;top:0;background:#fff}
  .scroll-x{overflow-x:auto;-webkit-overflow-scrolling:touch}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--panel);font-size:12px;color:var(--muted);white-space:nowrap}
  .pill.ok{border-color:#bbf7d0;background:#ecfdf5;color:#166534}
  .pill.warn{border-color:#fecaca;background:#fee2e2;color:#991b1b}
  .red{color:var(--bad);font-weight:700}
  .green{color:var(--ok);font-weight:700}
  .ac-box{position:absolute;background:#fff;border:1px solid var(--border);border-radius:8px;box-shadow:0 8px 16px rgba(0,0,0,.08);z-index:9999;overflow:hidden;max-height:220px;overflow-y:auto}
  .ac-item{padding:8px 10px;cursor:pointer;font-size:14px}
  .ac-item:hover{background:#f3f4f6}
  .prov-bar{display:flex;gap:8px;flex-wrap:wrap}
  .prov-btn{padding:8px 12px;border-radius:999px;border:1px solid var(--kiwi);background:#fff;color:#16a34a;cursor:pointer;font-size:13px}
  .prov-btn.active{background:var(--kiwi);color:#fff}
  .ok-assign{border:1px solid var(--kiwi);background:#ecfdf5;color:#166534;border-radius:10px;padding:6px 10px;cursor:pointer}
  .dup{background:#fff5f5}
  .dup .flag{color:#b91c1c;font-weight:700;margin-left:6px}
  .tabbar{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--border);
    display:flex;justify-content:space-around;align-items:center;height:56px;z-index:999;}
  .tabbar button{background:#fff;border:none;color:var(--muted);font-size:12px;display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer}
  .tabbar button.active{color:var(--kiwi)}
  .grid-3{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:980px){.grid-3{grid-template-columns:repeat(3,1fr)}}
  .status{font-size:12px;color:#166534}
  .status.err{color:#b91c1c}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .brand{display:flex;align-items:center;gap:10px}
  .brand svg{width:34px;height:34px}
  .chip{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff}
</style>
</head>
<body>
  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div class="brand">
        <!-- SVG KIWI LOGO: c√≠rculo verde con semillas -->
        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-label="Kiwi logo">
          <defs>
            <radialGradient id="g" cx="50%" cy="50%" r="50%">
              <stop offset="0%" stop-color="#a7f3d0"/>
              <stop offset="60%" stop-color="#22c55e"/>
              <stop offset="100%" stop-color="#15803d"/>
            </radialGradient>
          </defs>
          <circle cx="50" cy="50" r="46" fill="url(#g)" stroke="#065f46" stroke-width="4"/>
          <circle cx="50" cy="50" r="14" fill="#fefce8" stroke="#f59e0b" stroke-width="2"/>
          <!-- semillas -->
          <g fill="#111827">
            <ellipse cx="50" cy="30" rx="2" ry="4"/>
            <ellipse cx="65" cy="35" rx="2" ry="4" transform="rotate(25 65 35)"/>
            <ellipse cx="72" cy="48" rx="2" ry="4" transform="rotate(60 72 48)"/>
            <ellipse cx="65" cy="63" rx="2" ry="4" transform="rotate(95 65 63)"/>
            <ellipse cx="50" cy="70" rx="2" ry="4"/>
            <ellipse cx="35" cy="63" rx="2" ry="4" transform="rotate(-95 35 63)"/>
            <ellipse cx="28" cy="48" rx="2" ry="4" transform="rotate(-60 28 48)"/>
            <ellipse cx="35" cy="35" rx="2" ry="4" transform="rotate(-25 35 35)"/>
          </g>
        </svg>
        <h1>üçà ARSLAN LISTAS v3.8 ‚Äî KIWI MOBILE + SUPABASE</h1>
      </div>
      <div class="toolbar">
        <button class="btn ghost" onclick="manualSync()">üîÅ Sincronizar</button>
        <button class="btn" onclick="terminarTarea()">üßπ Terminar Tarea</button>
        <span id="syncStatus" class="status">Sincronizado</span>
      </div>
    </div>
    <div class="hint" style="margin-bottom:10px">Flujo: Diccionario ‚Üí Tiendas ‚Üí Global ‚Üí Proveedores ‚Üí Compras ‚Üí Reparto ‚Üí <b>Terminar Tarea</b></div>

    <!-- ========== TAB: Diccionario ========== -->
    <section class="tab" id="tab-dic">
      <div class="card">
        <div class="hd">
          <strong>üìö Vocabulario estandarizado (compartido)</strong>
          <div class="toolbar">
            <button class="btn ghost" onclick="addNewWord()">+ Nuevo producto</button>
            <button class="btn" onclick="saveVocab()">Guardar vocabulario</button>
            <button class="btn muted" onclick="resetAll()">üßπ Limpiar todo</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:6px">Un producto por l√≠nea. Se normaliza a <b>MAY√öSCULAS</b> sin tildes. Sin duplicados. <span class="chip">Auto-sync: ON</span></div>
          <textarea id="vocabTxt"></textarea>
        </div>
      </div>
    </section>

    <!-- ========== TAB: Tiendas ========== -->
    <section class="tab" id="tab-tiendas" style="display:none">
      <div class="grid-3">
        <!-- San Pablo -->
        <div class="card">
          <div class="hd"><strong>üè™ San Pablo</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('sp')">Estandarizar</button>
              <button class="btn muted" onclick="exportarTiendaTXT('sp')">üìÑ TXT</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_sp" placeholder="Pega lista San Pablo...&#10;Ej.: 3 cajas tomate daniela&#10;zanahoria 2&#10;aguacate granel 4"></textarea>
            <div class="hint">Edita en la tabla: OK = verde, Revisar = rojo. Sugerencias al escribir. <span class='chip'>Auto-sync: ON</span></div>
            <div id="tbl_sp_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>
        <!-- San Lesmes -->
        <div class="card">
          <div class="hd"><strong>üè™ San Lesmes</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('sl')">Estandarizar</button>
              <button class="btn muted" onclick="exportarTiendaTXT('sl')">üìÑ TXT</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_sl" placeholder="Pega lista San Lesmes..."></textarea>
            <div class="hint">Edita en la tabla: OK = verde, Revisar = rojo. Sugerencias al escribir. <span class='chip'>Auto-sync: ON</span></div>
            <div id="tbl_sl_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>
        <!-- Santiago -->
        <div class="card">
          <div class="hd"><strong>üè™ Santiago</strong>
            <div class="toolbar">
              <button class="btn ghost" onclick="estandarizar('st')">Estandarizar</button>
              <button class="btn muted" onclick="exportarTiendaTXT('st')">üìÑ TXT</button>
            </div>
          </div>
          <div class="bd">
            <textarea id="in_st" placeholder="Pega lista Santiago..."></textarea>
            <div class="hint">Edita en la tabla: OK = verde, Revisar = rojo. Sugerencias al escribir. <span class='chip'>Auto-sync: ON</span></div>
            <div id="tbl_st_wrap" class="scroll-x" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== TAB: Global ========== -->
    <section class="tab" id="tab-global" style="display:none">
      <div class="card">
        <div class="hd"><strong>üßÆ Unificaci√≥n global</strong>
          <div class="toolbar">
            <button class="btn ghost" onclick="unificarGlobal()">Unificar 3 tiendas</button>
            <button class="btn muted" onclick="exportarGlobalTXT()">TXT visible</button>
            <button class="btn muted" onclick="exportarGlobalXLSX()">Excel</button>
            <button class="btn" onclick="exportResumenGlobalTXT()">üìÑ TXT Global (asignados + pendientes)</button>
            <button class="btn ghost" onclick="shareWhatsAppGlobal()">üì≤ WhatsApp Global</button>
            <button class="btn muted" onclick="copiarGlobal()">Copiar</button>
          </div>
        </div>
        <div class="bd">
          <div class="card" style="margin-bottom:8px">
            <div class="bd row">
              <span class="hint">Proveedor activo:</span>
              <div class="prov-bar" id="provBar"></div>
              <span class="hint">‚úÖ asigna r√°pido. Duplicados en <span class="red">rojo</span>.</span>
            </div>
          </div>
          <div id="global_wrap" class="scroll-x" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- ========== TAB: Proveedores ========== -->
    <section class="tab" id="tab-proveedores" style="display:none">
      <div class="card">
        <div class="hd"><strong>üì¶ Distribuci√≥n por proveedor</strong></div>
        <div class="bd">
          <div class="grid-3" id="provPanels" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- ========== TAB: Compras (nuevo) ========== -->
    <section class="tab" id="tab-compras" style="display:none">
      <div class="card">
        <div class="hd">
          <strong>üõí Compras realizadas</strong>
          <div class="toolbar">
            <button class="btn small" onclick="marcarCompradoDesdeGlobal()">+ A√±adir seleccionados del Global</button>
            <button class="btn ghost small" onclick="supaReplaceComprasLocal()">Guardar en Supabase</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">Puedes a√±adir manualmente compras libres (producto, cantidad y proveedor opcional). <span class='chip'>Auto-sync: ON</span></div>
          <div class="row" style="margin-bottom:10px">
            <input id="buy_name" type="text" placeholder="PRODUCTO" style="flex:2;min-width:180px" />
            <input id="buy_qty" type="number" placeholder="CANTIDAD" step="0.01" style="width:120px" />
            <input id="buy_prov" type="text" placeholder="PROVEEDOR (opcional)" style="flex:1;min-width:140px" />
            <button class="btn" onclick="addCompraManual()">A√±adir</button>
          </div>
          <div id="compras_wrap"></div>
        </div>
      </div>
    </section>

    <!-- ========== TAB: Reparto (nuevo) ========== -->
    <section class="tab" id="tab-reparto" style="display:none">
      <div class="card">
        <div class="hd">
          <strong>üè™ Reparto por tienda (solo productos comprados)</strong>
          <div class="toolbar">
            <button class="btn small" onclick="rebuildRepartoFromCompras()">Refrescar desde Compras</button>
            <button class="btn ghost small" onclick="supaReplaceRepartoLocal()">Guardar reparto en Supabase</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-bottom:8px">Introduce las cantidades para cada tienda. Los productos no comprados no aparecen aqu√≠. <span class='chip'>Auto-sync: ON</span></div>
          <div id="reparto_wrap" class="grid-3"></div>
        </div>
      </div>
    </section>

  </div>

  <!-- Tabbar m√≥vil -->
  <nav class="tabbar">
    <button id="btn-dic" class="active" onclick="showTab('dic')">üìö<span>Diccionario</span></button>
    <button id="btn-tiendas" onclick="showTab('tiendas')">üè™<span>Tiendas</span></button>
    <button id="btn-global" onclick="showTab('global')">üßÆ<span>Global</span></button>
    <button id="btn-proveedores" onclick="showTab('proveedores')">üì¶<span>Proveedores</span></button>
    <button id="btn-compras" onclick="showTab('compras')">üõí<span>Compras</span></button>
    <button id="btn-reparto" onclick="showTab('reparto')">üè™<span>Reparto</span></button>
  </nav>

<script>
/* ==========================
   Tabs
========================== */
function showTab(key){
  const ids = ['dic','tiendas','global','proveedores','compras','reparto'];
  ids.forEach(k=>{
    document.getElementById('tab-'+k).style.display = (k===key)?'block':'none';
    document.getElementById('btn-'+k).classList.toggle('active', k===key);
  });
  if(key==='global'){ unificarGlobal(); buildProvBar(); }
  if(key==='proveedores'){ renderProvidersPanels(); }
  if(key==='compras'){ renderCompras(); }
  if(key==='reparto'){ renderReparto(); }
}

/* ==========================
   Supabase (config + helpers)
========================== */
const SUPA_URL = "https://esvfgvfqttvjcrsnxufq.supabase.co";
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzdmZndmZxdHR2amNyc254dWZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNTIwNjIsImV4cCI6MjA3NzgyODA2Mn0.SdtgaK6c7gJAxA8jH77w0K3ctMlvGx6g4YLYrI0PKuw";
const supa = supabase.createClient(SUPA_URL, SUPA_KEY);
const SUPA = {
  vocab: 'vocabulario',
  tiendas: 'tiendas_estandarizadas',
  compras: 'compras_realizadas',
  reparto: 'reparto_realizado'
};
const syncSpan = document.getElementById('syncStatus');
function setSyncStatus(msg, ok=true){
  syncSpan.textContent = msg;
  syncSpan.classList.toggle('err', !ok);
}

// Debounce helper para autosync
function debounce(fn, wait){ let t; return function(...args){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args), wait); }; }
const autoSyncVocab = debounce(async ()=>{ await saveVocab(); }, 600);
const autoSyncStore = debounce(async (code)=>{ await supaReplaceStore(code, tiendaState[code]||[]); }, 600);

/* ====== Supabase: Vocab ====== */
async function supaFetchVocab(){
  const { data, error } = await supa.from(SUPA.vocab).select('termino').order('termino',{ascending:true});
  if(error){ setSyncStatus('Vocab: error al descargar', false); return null; }
  setSyncStatus('Vocab descargado');
  return data.map(r => r.termino);
}
async function supaReplaceVocab(list){
  const { error: delErr } = await supa.from(SUPA.vocab).delete().neq('termino','__KEEP__');
  if(delErr){ setSyncStatus('Vocab: error al limpiar', false); return false; }
  if(!list.length){ setSyncStatus('Vocab vac√≠o (limpiado)'); return true; }
  const payload = list.map(t => ({ termino: t }));
  const { error: insErr } = await supa.from(SUPA.vocab).insert(payload);
  if(insErr){ setSyncStatus('Vocab: error al insertar', false); return false; }
  setSyncStatus('Vocab guardado');
  return true;
}

/* ====== Supabase: Tiendas ====== */
async function supaFetchTiendas(){
  const { data, error } = await supa.from(SUPA.tiendas)
    .select('tienda, producto, cantidad, original, estado, actualizado_en')
    .order('tienda', {ascending:true});
  if(error){ setSyncStatus('Tiendas: error al descargar', false); return null; }
  setSyncStatus('Tiendas descargadas');
  return data;
}
async function supaReplaceStore(code, rows){
  const { error: delErr } = await supa.from(SUPA.tiendas).delete().eq('tienda', code);
  if(delErr){ setSyncStatus(code.toUpperCase()+': error al limpiar', false); return false; }
  if(!rows.length){ setSyncStatus(code.toUpperCase()+': sin filas (vac√≠o)'); return true; }
  const payload = rows.map(r => ({
    tienda: code,
    producto: r.e,
    cantidad: Number(r.q)||0,
    original: r.o,
    estado: r.a ? 'revisar' : 'ok'
  }));
  const { error: insErr } = await supa.from(SUPA.tiendas).insert(payload);
  if(insErr){ setSyncStatus(code.toUpperCase()+': error al insertar', false); return false; }
  setSyncStatus(code.toUpperCase()+': guardado');
  return true;
}

/* ====== Supabase: Compras ====== */
async function supaFetchCompras(){
  const { data, error } = await supa.from(SUPA.compras).select('producto,cantidad,proveedor,comprado_en').order('comprado_en',{ascending:true});
  if(error){ setSyncStatus('Compras: error al descargar', false); return null; }
  return data||[];
}
async function supaReplaceCompras(list){
  const { error: delErr } = await supa.from(SUPA.compras).delete().neq('producto','__KEEP__');
  if(delErr){ setSyncStatus('Compras: error al limpiar', false); return false; }
  if(!list.length){ setSyncStatus('Compras vac√≠as'); return true; }
  const payload = list.map(x=>({producto:x.name,cantidad:Number(x.qty)||0,proveedor:x.prov||null}));
  const { error: insErr } = await supa.from(SUPA.compras).insert(payload);
  if(insErr){ setSyncStatus('Compras: error al insertar', false); return false; }
  setSyncStatus('Compras guardadas');
  return true;
}

/* ====== Supabase: Reparto ====== */
async function supaFetchReparto(){
  const { data, error } = await supa.from(SUPA.reparto).select('tienda,producto,cantidad,repartido_en').order('repartido_en',{ascending:true});
  if(error){ setSyncStatus('Reparto: error al descargar', false); return null; }
  return data||[];
}
async function supaReplaceReparto(list){
  const { error: delErr } = await supa.from(SUPA.reparto).delete().neq('producto','__KEEP__');
  if(delErr){ setSyncStatus('Reparto: error al limpiar', false); return false; }
  if(!list.length){ setSyncStatus('Reparto vac√≠o'); return true; }
  const payload = list.map(x=>({tienda:x.tienda, producto:x.producto, cantidad:Number(x.cantidad)||0}));
  const { error: insErr } = await supa.from(SUPA.reparto).insert(payload);
  if(insErr){ setSyncStatus('Reparto: error al insertar', false); return false; }
  setSyncStatus('Reparto guardado');
  return true;
}

/* ====== Sincronizaci√≥n manual (descarga) ====== */
async function manualSync(){
  setSyncStatus('Sincronizando...');

  // Vocab
  const sv = await supaFetchVocab();
  if(sv && sv.length){
    const unique = uniqueVocab(sv);
    byId('vocabTxt').value = unique.join('\n');
    localStorage.setItem(LS.VOCAB, byId('vocabTxt').value);
  }

  // Tiendas
  const st = await supaFetchTiendas();
  if(st){
    const map = { sp:[], sl:[], st:[] };
    st.forEach(r=>{
      map[r.tienda]?.push({
        o: removeDiacriticsUpper(r.original||r.producto),
        e: removeDiacriticsUpper(r.producto),
        q: Number(r.cantidad)||0,
        a: (r.estado==='revisar')
      });
    });
    tiendaState.sp = map.sp; tiendaState.sl = map.sl; tiendaState.st = map.st;
    persistState();
    ['sp','sl','st'].forEach(code=> renderTable(code));
    unificarGlobal();
    renderProvidersPanels();
  }

  // Compras
  const comp = await supaFetchCompras();
  if(comp){
    purchases = comp.map(r=>({name:removeDiacriticsUpper(r.producto), qty:Number(r.cantidad)||0, prov: r.proveedor||''}));
    persistState();
    renderCompras();
  }

  // Reparto
  const rep = await supaFetchReparto();
  if(rep){
    reparto = {sp:[], sl:[], st:[]};
    rep.forEach(r=>{
      if(reparto[r.tienda]) reparto[r.tienda].push({name:removeDiacriticsUpper(r.producto), qty:Number(r.cantidad)||0});
    });
    persistState(); renderReparto();
  }

  setSyncStatus('Sincronizado');
}

/* ==========================
   Config y utilidades
========================== */
const LS = {
  VOCAB:'arslan_v38_vocab',
  STORES:'arslan_v38_stores',
  ASSIGN:'arslan_v38_assign',
  ORDERS:'arslan_v38_orders',
  COMPRAS:'arslan_v38_compras',
  REPARTO:'arslan_v38_reparto'
};
const PROVEEDORES = ["ESMO","MONTENEGRO","√ÅNGEL VACA","JOS√â ANTONIO","JAVI","ANGELO"];
const IGNORE_WORDS = ['caja','cajas','kg','kilo','kilos','uds','ud','u','unidad','unidades','manojo','manojos','saco','sacos'];

const $ = s => document.querySelector(s);
const byId = id => document.getElementById(id);
const toLines = t => String(t||'').split(/[\n\r,]/).map(x=>x.trim()).filter(Boolean);

function removeDiacriticsUpper(s){
  return String(s||'')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/√±/g,'N').replace(/√ë/g,'N')
    .toUpperCase();
}
function normKey(s){
  return removeDiacriticsUpper(s)
    .replace(/[^A-Z0-9\s]/g,' ')
    .replace(/\s+/g,' ')
    .trim();
}
function stripGenericWords(s){
  const tokens = normKey(s).split(' ').filter(t=>!IGNORE_WORDS.includes(t.toLowerCase()));
  return tokens.join(' ').trim();
}

/* ==========================
   Vocabulario (editable + persistente + Supabase)
========================== */
const OFFICIAL_VOCAB_RAW = `GRANNY FRANCIA
MANZANA PINK LADY
MANDARINA COLOMBE
KIWI ZESPRI GOLD
PARAGUAYO 
KIWI TOMASIN PLANCHA
PERA RINCON DEL SOTO
MELOCOTON PRIMERA
AGUACATE GRANEL
MARACUYA
MANZANA GOLDEN 24
PLATANO CANARIO PRIMERA
MANDARINA HOJA
MANZANA GOLDEN 20
NARANJA TOMASIN
NECTARINA
NUECES
SANDIA
LIMON SEGUNDA
MANZANA FUJI
NARANJA MESA SONRISA
JENGIBRE
BATATA
AJO PRIMERA
CEBOLLA NORMAL
CALABAZA GRANDE
PATATA LAVADA
TOMATE CHERRY RAMA
TOMATE CHERRY PERA
TOMATE DANIELA
TOMATE ROSA PRIMERA
CEBOLLINO
TOMATE ASURCADO MARRON
TOMATE RAMA
PIMIENTO PADRON
ZANAHORIA
PEPINO
CEBOLLETA
PUERROS
BROCOLI
JUDIA VERDE
BERENJENA
PIMIENTO ITALIANO VERDE
PIMIENTO ITALIANO ROJO
CHAMPINON
UVA ROJA
UVA BLANCA
ALCACHOFA
CALABACIN
COLIFLOR
BATAVIA
ICEBERG
MANDARINA SEGUNDA
MANZANA GOLDEN 28
NARANJA ZUMO
KIWI SEGUNDA
MANZANA ROYAL GALA 24
PLATANO CANARIO SUELTO
CEREZA
FRESAS
ARANDANOS
ESPINACA
PEREJIL
CILANTRO
ACELGAS
PIMIENTO VERDE
PIMIENTO ROJO
MACHO VERDE
MACHO MADURO
YUCA
AVOCADO
CEBOLLA ROJA
MENTA
HABANERO
RABANITOS
POMELO
PAPAYA
REINETA 28
NISPERO
ALBARICOQUE
TOMATE PERA
TOMATE BOLA
TOMATE PINK
VALVENOSTA GOLDEN
MELOCOTON ROJO
MELON GALIA
APIO
NARANJA SANHUJA
LIMON PRIMERA
MANGO
MELOCOTON AMARILLO
VALVENOSTA ROJA
PINA
NARANJA HOJA
PERA CONFERENCIA SEGUNDA
CEBOLLA DULCE
TOMATE ASURCADO AZUL
ESPARRAGOS BLANCOS
ESPARRAGOS TRIGUEROS
REINETA PRIMERA
AGUACATE PRIMERA
COCO
NECTARINA SEGUNDA
REINETA 24
NECTARINA CARNE BLANCA
GUINDILLA
REINETA VERDE
PATATA 25KG
PATATA 5 KG
TOMATE RAFF
REPOLLO
KIWI ZESPRI
PARAGUAYO SEGUNDA
MELON
REINETA 26
TOMATE ROSA
MANZANA CRISPS
ALOE VERA PIEZAS
TOMATE ENSALADA
PATATA 10KG
MELON BOLLO
CIRUELA ROJA
LIMA
GUINEO VERDE
SETAS
BANANA
BONIATO
FRAMBUESA
BREVAS
PERA AGUA
YAUTIA
YAME
OKRA
MANZANA MELASSI
CACAHUETE
SANDIA NEGRA
SANDIA RAYADA
HIGOS
KUMATO
KIWI CHILE
MELOCOTON AMARILLO SEGUNDA
HIERBABUENA
REMOLACHA
LECHUGA ROMANA
KAKI
CIRUELA CLAUDIA
PERA LIMONERA
CIRUELA AMARILLA
HIGOS BLANCOS
UVA ALVILLO
LIMON EXTRA
PITAHAYA ROJA
HIGO CHUMBO
CLEMENTINA
GRANADA
NECTARINA PRIMERA BIS
CHIRIMOYA
UVA CHELVA
PIMIENTO CALIFORNIA VERDE
KIWI TOMASIN
PIMIENTO CALIFORNIA ROJO
MANDARINA SATSUMA
CASTANA
CAKI
MANZANA KANZI
PERA ERCOLINA
NABO
UVA ALVILLO NEGRA
CHAYOTE
ROYAL GALA 28
MANDARINA PRIMERA
PIMIENTO PINTON
MELOCOTON AMARILLO DE CALANDA
HINOJOS
MANDARINA DE HOJA
UVA ROJA PRIMERA
UVA BLANCA PRIMERA`;

function uniqueVocab(lines){
  const seen = new Set(); const out=[];
  for(const l of lines){
    const t = removeDiacriticsUpper(l).trim();
    if(!t) continue;
    const k = normKey(t);
    if(!seen.has(k)){ seen.add(k); out.push(t); }
  }
  return out;
}
function loadVocab(){
  const saved = localStorage.getItem(LS.VOCAB);
  const base = saved && saved.trim()? saved : OFFICIAL_VOCAB_RAW;
  const list = uniqueVocab(toLines(base));
  byId('vocabTxt').value = list.join('\n');
  return list;
}
async function saveVocab(){
  const list = uniqueVocab(toLines(byId('vocabTxt').value));
  byId('vocabTxt').value = list.join('\n');
  localStorage.setItem(LS.VOCAB, byId('vocabTxt').value||'');
  setSyncStatus('Guardando vocabulario...');
  await supaReplaceVocab(list);
  setSyncStatus('Vocabulario sincronizado');
  renderProvidersPanels();
  unificarGlobal();
}
function addNewWord(){
  const entry = prompt("Introduce nuevo producto (uno por l√≠nea si son varios):");
  if(!entry) return;
  const current = toLines(byId('vocabTxt').value);
  const added = toLines(entry);
  const merged = uniqueVocab(current.concat(added));
  byId('vocabTxt').value = merged.join('\n');
  autoSyncVocab();
}
byId('vocabTxt').addEventListener('input', autoSyncVocab);

/* ==========================
   Coincidencia aproximada (mejorada)
========================== */
function bigrams(str){
  const s = stripGenericWords(str);
  const arr=[]; for(let i=0;i<s.length-1;i++){ if(s[i]!==' '&&s[i+1]!==' ') arr.push(s.slice(i,i+2)); }
  return arr;
}
function diceSim(a,b){
  const A=bigrams(a), B=bigrams(b);
  if(!A.length||!B.length) return 0;
  let hits=0; const pool=B.slice();
  A.forEach(bg=>{const idx=pool.indexOf(bg); if(idx>-1){hits++; pool.splice(idx,1);} });
  return (2*hits)/(A.length+B.length);
}
function tokenSetSim(a,b){
  const A=new Set(stripGenericWords(a).split(' ').filter(Boolean));
  const B=new Set(stripGenericWords(b).split(' ').filter(Boolean));
  if(!A.size||!B.size) return 0;
  let inter=0; A.forEach(x=>{ if(B.has(x)) inter++; });
  return inter / Math.max(A.size,B.size);
}
function similarityScore(a,b){ return 0.7*diceSim(a,b) + 0.3*tokenSetSim(a,b); }
function bestMatch(query, vocabArr){
  const q = stripGenericWords(query);
  let best = {name:null, score:0};
  vocabArr.forEach(v=>{
    const sc = similarityScore(q, v);
    if(sc>best.score) best = {name:v, score:sc};
  });
  return best;
}

/* ==========================
   Parser l√≠neas (cantidad + nombre)
========================== */
function parseLine(raw){
  if(!raw) return null;
  let s = raw.replace(/\t/g,' ').replace(/\s{2,}/g,' ').trim();
  s = s.replace(/^[‚àí-‚Ä¢*]\s*/,'');
  let qty=null, name=s;

  const mX = s.match(/(?:x|X|\*)\s*(\d+[\.,]?\d*)\b/);
  if(mX){ qty=Number(mX[1].replace(',','.')); name=s.replace(mX[0],'').trim(); }

  if(qty===null){
    const mEnd = s.match(/(\d+[\.,]?\d*)\s*(?:kg|kgs|kilo|kilos|uds|ud|u|unidad|unidades|caja|cajas)?\s*$/i);
    if(mEnd){ qty=Number(mEnd[1].replace(',','.')); name=s.slice(0,mEnd.index).trim(); }
  }
  if(qty===null){
    const mStart = s.match(/^\s*(\d+[\.,]?\d*)\s+(.*)$/);
    if(mStart){ qty=Number(mStart[1].replace(',','.')); name=mStart[2].trim(); }
  }
  if(qty===null){ qty=1; }

  name = stripGenericWords(name);
  return { original: removeDiacriticsUpper(s), name, qty };
}

/* ==========================
   Estado
========================== */
const tiendaState = { sp:[], sl:[], st:[] }; // [{o,e,q,a}]
let globalRows = [];                          // [{name,total}]
let assignments = {};                         // { normKey(name) : proveedor }
let orders = {};                              // { proveedor : [{name, qty}] }
let purchases = [];                           // [{name, qty, prov}]
let reparto = { sp:[], sl:[], st:[] };       // por tienda: [{name, qty}]
let ACTIVE_PROV = PROVEEDORES[0];

function loadState(){
  try{
    const s = JSON.parse(localStorage.getItem(LS.STORES)||'{}');
    ['sp','sl','st'].forEach(k=>{ if(Array.isArray(s[k])) tiendaState[k]=s[k]; });
  }catch{}
  try{
    const a = JSON.parse(localStorage.getItem(LS.ASSIGN)||'{}');
    assignments = a||{};
  }catch{}
  try{
    const o = JSON.parse(localStorage.getItem(LS.ORDERS)||'{}');
    orders = o||{};
  }catch{}
  try{
    const c = JSON.parse(localStorage.getItem(LS.COMPRAS)||'[]');
    purchases = Array.isArray(c)? c : [];
  }catch{}
  try{
    const r = JSON.parse(localStorage.getItem(LS.REPARTO)||'{}');
    reparto = r && typeof r==='object'? r : {sp:[],sl:[],st:[]};
  }catch{}
  PROVEEDORES.forEach(p=>{ if(!Array.isArray(orders[p])) orders[p]=[]; });
}
function persistState(){
  localStorage.setItem(LS.STORES, JSON.stringify(tiendaState));
  localStorage.setItem(LS.ASSIGN, JSON.stringify(assignments));
  localStorage.setItem(LS.ORDERS, JSON.stringify(orders));
  localStorage.setItem(LS.COMPRAS, JSON.stringify(purchases));
  localStorage.setItem(LS.REPARTO, JSON.stringify(reparto));
}
function resetAll(){
  if(confirm('¬øSeguro que quieres limpiar todo?')){ localStorage.clear(); location.reload(); }
}

/* ==========================
   Estandarizar por tienda (AUTO-SYNC)
========================== */
let AC_ACTIVE = null;
function closeAC(){ if(AC_ACTIVE){ AC_ACTIVE.remove(); AC_ACTIVE=null; } }

function attachAutocomplete(cell, onPick){
  cell.addEventListener('input', ()=>{
    const val = stripGenericWords(cell.innerText||'');
    closeAC();
    if(!val) return;
    const vocab = loadVocab();
    const suggestions = vocab.filter(v=> normKey(v).includes(normKey(val))).slice(0,8);
    if(!suggestions.length) return;
    const rect = cell.getBoundingClientRect();
    const box = document.createElement('div');
    box.className='ac-box';
    box.style.left = (rect.left + window.scrollX) + 'px';
    box.style.top = (rect.bottom + window.scrollY) + 'px';
    box.style.width = rect.width + 'px';
    suggestions.forEach(s=>{
      const item = document.createElement('div');
      item.className='ac-item';
      item.textContent = s;
      item.onclick = ()=>{ onPick(s); closeAC(); };
      box.appendChild(item);
    });
    document.body.appendChild(box);
    AC_ACTIVE = box;
  });
  document.addEventListener('click', (e)=>{ if(AC_ACTIVE && !AC_ACTIVE.contains(e.target) && e.target!==cell){ closeAC(); }}, {capture:true});
}

function renderTable(code){
  const wrap = byId('tbl_'+code+'_wrap');
  const rows = tiendaState[code]||[];
  if(!rows.length){ wrap.innerHTML=''; return; }
  let html = '<div class="scroll-x"><table><thead><tr><th>Original</th><th>Estandarizado</th><th>Cantidad</th><th>Estado</th></tr></thead><tbody>';
  rows.forEach((r,i)=>{
    html += `<tr>
      <td>${r.o}</td>
      <td contenteditable="true" data-i="${i}" data-f="e" ${r.a? 'class="red"':''}>${r.e}</td>
      <td contenteditable="true" data-i="${i}" data-f="q">${r.q}</td>
      <td>${r.a? '<span class="pill warn">Revisar</span>':'<span class="pill ok">OK</span>'}</td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  wrap.innerHTML = html;

  wrap.querySelectorAll('td[contenteditable]').forEach(cell=>{
    const i = Number(cell.dataset.i);
    const f = cell.dataset.f;
    if(f==='e'){
      attachAutocomplete(cell, (picked)=>{
        cell.innerText = picked;
        tiendaState[code][i].e = picked;
        tiendaState[code][i].a = false;
        cell.classList.remove('red');
        cell.parentElement.querySelector('td:last-child').innerHTML = '<span class="pill ok">OK</span>';
        persistState();
        autoSyncStore(code);
      });
    }
    cell.addEventListener('blur', ()=>{
      const val = cell.innerText.trim();
      if(f==='q'){
        tiendaState[code][i].q = Number(String(val).replace(',','.'))||0;
      }else{
        const cleaned = removeDiacriticsUpper(val);
        tiendaState[code][i].e = cleaned;
        const vocab = loadVocab();
        const exact = vocab.find(v=> normKey(v)===normKey(cleaned));
        const tdState = cell.parentElement.querySelector('td:last-child');
        if(exact){ tiendaState[code][i].a=false; cell.classList.remove('red'); tdState.innerHTML='<span class="pill ok">OK</span>'; }
        else { tiendaState[code][i].a=true; cell.classList.add('red'); tdState.innerHTML='<span class="pill warn">Revisar</span>'; }
      }
      persistState();
      autoSyncStore(code);
    });
  });
}

function estandarizar(code){
  const vocab = loadVocab();
  const txt = byId('in_'+code).value;
  const rows = [];
  toLines(txt).forEach(line=>{
    const p = parseLine(line);
    if(!p) return;
    const exact = vocab.find(v=> normKey(v)===normKey(p.name));
    if(exact){ rows.push({o:p.original, e:exact, q:p.qty, a:false}); return; }
    const m = bestMatch(p.name, vocab);
    const chosen = m.name || p.name;
    rows.push({o:p.original, e:chosen, q:p.qty, a:(normKey(chosen)!==normKey(p.name))});
  });
  tiendaState[code] = rows;
  renderTable(code);
  persistState();
  autoSyncStore(code);
}

function exportarTiendaTXT(code){
  const tienda = tiendaState[code] || [];
  if (!tienda.length) { alert('No hay datos estandarizados.'); return; }
  const okRows = tienda.filter(r => !r.a);
  if (!okRows.length) { alert('A√∫n hay productos por revisar (en rojo).'); return; }
  const today = new Date().toISOString().split('T')[0];
  const txt = okRows.map(x => `${x.q} ${x.e}`).join('\n');
  const blob = new Blob([txt], {type:'text/plain'});
  const a = document.createElement('a'); 
  a.href = URL.createObjectURL(blob); 
  a.download = `${code}_estandarizado_${today}.txt`; 
  a.click();
}

/* ==========================
   Unificar global + similares
========================== */
function unificarGlobal(){
  const all = [].concat(tiendaState.sp||[], tiendaState.sl||[], tiendaState.st||[]);
  const map = new Map();
  all.forEach(r=>{
    const key = normKey(r.e);
    if(!map.has(key)) map.set(key,{name:r.e,total:0});
    map.get(key).total += (Number(r.q)||0);
  });
  const arr = Array.from(map.values()).sort((a,b)=>a.name.localeCompare(b.name,'es'));

  // detectar similares
  const names = arr.map(x=>x.name);
  const similarSet = new Set();
  for(let i=0;i<names.length;i++){
    for(let j=i+1;j<names.length;j++){
      const s1 = names[i], s2 = names[j];
      const sc = similarityScore(s1, s2);
      if(sc>=0.86 && normKey(s1)!==normKey(s2)){
        similarSet.add(s1); similarSet.add(s2);
      }
    }
  }
  renderGlobalTable(arr, similarSet);
}

/* ==========================
   GLOBAL + Asignaci√≥n a proveedor
========================== */
function renderGlobalTable(rows, similarSet){
  const visible = rows.filter(r => !assignments[normKey(r.name)]);
  globalRows = visible;

  const wrap = byId('global_wrap');
  if(!visible.length){ wrap.innerHTML='<div class="hint">Sin productos (todo asignado o no unificado).</div>'; return; }

  let html = `
    <div class="hint" style="margin-bottom:6px">
      Proveedor activo: <b>${ACTIVE_PROV}</b>. Usa ‚úÖ para asignar r√°pidamente.
    </div>
    <div class="scroll-x"><table>
      <thead><tr><th></th><th>Producto</th><th>Total</th><th>Estado</th></tr></thead>
      <tbody>`;
  visible.forEach((r,i)=>{
    const isSimilar = similarSet.has(r.name);
    html += `<tr data-i="${i}" class="${isSimilar?'dup':''}">
      <td><button class="ok-assign" onclick="assignFromGlobal(${i})">‚úÖ</button></td>
      <td contenteditable="true" data-f="name">${r.name}${isSimilar?'<span class="flag">‚ö†Ô∏è</span>':''}</td>
      <td contenteditable="true" data-f="total">${r.total}</td>
      <td>${isSimilar? '<span class="pill warn">Posible duplicado</span>':'<span class="pill ok">OK</span>'}</td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  wrap.innerHTML = html;

  wrap.querySelectorAll('td[contenteditable]').forEach(cell=>{
    const tr = cell.parentElement;
    const idx = Number(tr.dataset.i);
    const f = cell.dataset.f;
    if(f==='name'){
      attachAutocomplete(cell, (picked)=>{
        cell.innerText = picked;
        globalRows[idx].name = picked;
        tr.classList.remove('dup');
        tr.querySelector('td:last-child').innerHTML = '<span class="pill ok">OK</span>';
      });
    }
    cell.addEventListener('blur', ()=>{
      const val = cell.innerText.trim();
      if(f==='total'){
        globalRows[idx].total = Number(String(val).replace(',','.'))||0;
      }else{
        const cleaned = removeDiacriticsUpper(val);
        globalRows[idx].name = cleaned;
        const vocab = loadVocab();
        const exact = vocab.find(v=> normKey(v)===normKey(cleaned));
        if(exact){
          tr.classList.remove('dup');
          tr.querySelector('td:last-child').innerHTML = '<span class="pill ok">OK</span>';
        }else{
          let dup = false;
          for(let k=0;k<globalRows.length;k++){
            if(k===idx) continue;
            const sc = similarityScore(globalRows[idx].name, globalRows[k].name);
            if(sc>=0.86 && normKey(globalRows[idx].name)!==normKey(globalRows[k].name)){ dup=true; break; }
          }
          if(dup){
            tr.classList.add('dup');
            tr.querySelector('td:last-child').innerHTML = '<span class="pill warn">Posible duplicado</span>';
          }else{
            tr.classList.remove('dup');
            tr.querySelector('td:last-child').innerHTML = '<span class="pill ok">OK</span>';
          }
        }
      }
    });
  });
}

function assignFromGlobal(idx){
  const item = globalRows[idx];
  if(!item) return;
  const k = normKey(item.name);
  assignments[k] = ACTIVE_PROV;

  const list = orders[ACTIVE_PROV]||[];
  const exIdx = list.findIndex(x=> normKey(x.name)===k);
  if(exIdx>-1){ list[exIdx].qty += Number(item.total)||0; }
  else{ list.push({name:item.name, qty:Number(item.total)||0}); }
  orders[ACTIVE_PROV] = list;

  persistState();
  unificarGlobal();
  renderProvidersPanels();
}

/* ==========================
   Barra de proveedores + paneles
========================== */
function buildProvBar(){
  const bar = byId('provBar'); bar.innerHTML='';
  PROVEEDORES.forEach(p=>{
    const b = document.createElement('button');
    b.className = 'prov-btn' + (p===ACTIVE_PROV?' active':'');
    b.textContent = p;
    b.onclick = ()=>{
      ACTIVE_PROV = p;
      buildProvBar();
      unificarGlobal();
    };
    bar.appendChild(b);
  });
}

function renderProvidersPanels(){
  const cont = byId('provPanels'); cont.innerHTML='';
  PROVEEDORES.forEach(p=>{
    const list = orders[p]||[];
    const card = document.createElement('div');
    card.className='card';
    const hd = document.createElement('div');
    hd.className='hd';
    hd.innerHTML = `<strong>${p}</strong>
      <div class="toolbar">
        <button class="btn small" onclick="exportProvTXT('${p}')">üìÑ TXT ${p}</button>
        <button class="btn small ghost" onclick="shareWhatsAppProv('${p}')">üì≤ WhatsApp ${p}</button>
      </div>`;
    const bd = document.createElement('div');
    bd.className='bd';

    if(!list.length){
      bd.innerHTML = '<div class="hint">Sin productos asignados.</div>';
    }else{
      let html = '<div class="scroll-x"><table><thead><tr><th>Producto</th><th>Cantidad</th></tr></thead><tbody>';
      list.forEach((it,ix)=>{
        html += `<tr>
          <td contenteditable="true" data-prov="${p}" data-idx="${ix}" data-f="name" class="green">${it.name}</td>
          <td contenteditable="true" data-prov="${p}" data-idx="${ix}" data-f="qty" class="green">${it.qty}</td>
        </tr>`;
      });
      html += '</tbody></table></div>';
      bd.innerHTML = html;

      bd.querySelectorAll('td[contenteditable]').forEach(cell=>{
        const prov = cell.dataset.prov;
        const idx = Number(cell.dataset.idx);
        const f = cell.dataset.f;
        if(f==='name'){
          attachAutocomplete(cell, picked=>{
            cell.innerText = picked;
            orders[prov][idx].name = picked;
            persistState();
          });
        }
        cell.addEventListener('blur', ()=>{
          const val = cell.innerText.trim();
          if(f==='qty'){
            orders[prov][idx].qty = Number(String(val).replace(',','.'))||0;
          }else{
            orders[prov][idx].name = removeDiacriticsUpper(val);
          }
          persistState();
        });
      });
    }

    card.appendChild(hd); card.appendChild(bd);
    cont.appendChild(card);
  });
}

function exportProvTXT(prov){
  const list = orders[prov]||[];
  if(!list.length){ alert('No hay l√≠neas para ' + prov); return; }
  const today = new Date().toISOString().split('T')[0];
  const txt = list.map(x=> `${x.qty} ${x.name}`).join('\n');
  const blob = new Blob([txt],{type:'text/plain'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`pedido_${prov}_${today}.txt`; a.click();
}

/* ==========================
   Exportaci√≥n/compartir Global
========================== */
function copiarGlobal(){
  if(!globalRows.length) return;
  const txt = globalRows.map(r=>`- ${r.total} ${r.name}`).join('\n');
  navigator.clipboard.writeText(txt);
  alert('Lista global copiada.');
}
function exportarGlobalTXT(){
  if(!globalRows.length){ alert('No hay datos.'); return; }
  const today = new Date().toISOString().split('T')[0];
  const txt = globalRows.map(r=>`${r.total}\t${r.name}`).join('\n');
  const blob = new Blob([txt],{type:'text/plain'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`lista_global_${today}.txt`; a.click();
}
function exportarGlobalXLSX(){
  if(!globalRows.length){ alert('No hay datos.'); return; }
  const today = new Date().toISOString().split('T')[0];
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet([["Producto","Total"], ...globalRows.map(r=>[r.name,r.total])]);
  XLSX.utils.book_append_sheet(wb, ws, 'Global');
  XLSX.writeFile(wb, `lista_global_${today}.xlsx`);
}

/* ============ WhatsApp (global y por proveedor) ============ */
function waEncode(text){ return encodeURIComponent(text); }
function openWhatsAppWith(text){
  const url = `https://wa.me/?text=${waEncode(text)}`;
  window.open(url, '_blank');
}
function shareWhatsAppProv(prov){
  const list = orders[prov]||[];
  const today = new Date().toISOString().split('T')[0];
  let msg = `üìù Pedido para ${prov} (${today}):\n`;
  if(!list.length){ msg += `- (sin l√≠neas)\n`; }
  else{
    list.forEach(x=>{ msg += `- ${x.qty} ${x.name}\n`; });
  }
  openWhatsAppWith(msg);
}
function shareWhatsAppGlobal(){
  const today = new Date().toISOString().split('T')[0];
  const allMap = {};
  const all = [].concat(tiendaState.sp||[], tiendaState.sl||[], tiendaState.st||[]);
  all.forEach(r=>{
    const k = normKey(r.e);
    if(!allMap[k]) allMap[k] = {name:r.e,total:0};
    allMap[k].total += (Number(r.q)||0);
  });
  const byProv = {}; PROVEEDORES.forEach(p=>byProv[p]=[]);
  const unassigned = [];
  Object.values(allMap).forEach(it=>{
    const k = normKey(it.name);
    const prov = assignments[k];
    if(prov && PROVEEDORES.includes(prov)){
      byProv[prov].push({name:it.name, qty:it.total});
    }else{
      unassigned.push({name:it.name, qty:it.total});
    }
  });

  let out = `üßæ RESUMEN DE PEDIDOS (${today})\n\n`;
  PROVEEDORES.forEach(p=>{
    out += `üìù Pedido para ${p}:\n`;
    if(byProv[p].length){
      byProv[p].sort((a,b)=>a.name.localeCompare(b.name,'es'));
      byProv[p].forEach(x=>{ out += `- ${x.qty} ${x.name}\n`; });
    }else{
      out += `- (sin l√≠neas)\n`;
    }
    out += `\n`;
  });
  out += `üìå PENDIENTES SIN PROVEEDOR:\n`;
  if(unassigned.length){
    unassigned.sort((a,b)=>a.name.localeCompare(b.name,'es'));
    unassigned.forEach(x=>{ out += `- ${x.qty} ${x.name}\n`; });
  }else{
    out += `- (sin l√≠neas)\n`;
  }
  openWhatsAppWith(out);
}

/* ==========================
   COMPRAS (nuevo)
========================== */
function renderCompras(){
  const wrap = byId('compras_wrap');
  if(!purchases.length){ wrap.innerHTML = '<div class="hint">Sin compras registradas.</div>'; return; }
  let html = '<div class="scroll-x"><table><thead><tr><th>Producto</th><th>Cantidad</th><th>Proveedor</th><th></th></tr></thead><tbody>';
  purchases.forEach((p,i)=>{
    html += `<tr>
      <td contenteditable="true" data-i="${i}" data-f="name" class="green">${p.name}</td>
      <td contenteditable="true" data-i="${i}" data-f="qty" class="green">${p.qty}</td>
      <td contenteditable="true" data-i="${i}" data-f="prov">${p.prov||''}</td>
      <td><button class="btn muted small" onclick="delCompra(${i})">Eliminar</button></td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  wrap.innerHTML = html;

  wrap.querySelectorAll('td[contenteditable]').forEach(cell=>{
    const i = Number(cell.dataset.i);
    const f = cell.dataset.f;
    if(f==='name'){
      attachAutocomplete(cell, picked=>{
        cell.innerText = picked;
        purchases[i].name = picked;
        persistState();
        supaReplaceComprasLocal();
      });
    }
    cell.addEventListener('blur', ()=>{
      const val = cell.innerText.trim();
      if(f==='qty'){ purchases[i].qty = Number(String(val).replace(',','.'))||0; }
      else if(f==='name'){ purchases[i].name = removeDiacriticsUpper(val); }
      else{ purchases[i].prov = removeDiacriticsUpper(val); }
      persistState();
      supaReplaceComprasLocal();
    });
  });
}
function addCompraManual(){
  const n = removeDiacriticsUpper(byId('buy_name').value||'').trim();
  const q = Number(String(byId('buy_qty').value||'').replace(',','.'))||0;
  const p = removeDiacriticsUpper(byId('buy_prov').value||'').trim();
  if(!n || q<=0){ alert('Producto y cantidad requeridos.'); return; }
  const idx = purchases.findIndex(x=> normKey(x.name)===normKey(n) && normKey(x.prov||'')===normKey(p||''));
  if(idx>-1){ purchases[idx].qty += q; }
  else purchases.push({name:n, qty:q, prov:p||''});
  byId('buy_name').value=''; byId('buy_qty').value=''; byId('buy_prov').value='';
  persistState(); renderCompras();
  supaReplaceComprasLocal();
}
function delCompra(i){
  purchases.splice(i,1);
  persistState(); renderCompras();
  supaReplaceComprasLocal();
}
function marcarCompradoDesdeGlobal(){
  if(!globalRows.length){ alert('Primero unifica (Global).'); return; }
  const allMap = {};
  PROVEEDORES.forEach(p=>{
    (orders[p]||[]).forEach(item=>{
      const k = normKey(item.name);
      if(!allMap[k]) allMap[k]={name:item.name, qty:0, prov:p};
      allMap[k].qty += Number(item.qty)||0;
      allMap[k].prov = p;
    });
  });
  globalRows.forEach(r=>{
    const k = normKey(r.name);
    if(!allMap[k]) allMap[k]={name:r.name, qty:0, prov:''};
    allMap[k].qty += Number(r.total)||0;
  });
  Object.values(allMap).forEach(x=>{
    const idx = purchases.findIndex(y=> normKey(y.name)===normKey(x.name) && normKey(y.prov||'')===normKey(x.prov||''));
    if(idx>-1){ purchases[idx].qty += x.qty; }
    else purchases.push({name:x.name, qty:x.qty, prov:x.prov||''});
  });
  persistState(); renderCompras();
  supaReplaceComprasLocal();
}
async function supaReplaceComprasLocal(){
  setSyncStatus('Guardando compras...');
  const ok = await supaReplaceCompras(purchases||[]);
  setSyncStatus(ok?'Compras guardadas':'Error compras', !!ok);
}

/* ==========================
   REPARTO (nuevo)
========================== */
function rebuildRepartoFromCompras(){
  const base = purchases.map(p=>({name:p.name, qty:p.qty}));
  reparto = {sp:[], sl:[], st:[]};
  base.forEach(b=>{
    reparto.sp.push({name:b.name, qty:0});
    reparto.sl.push({name:b.name, qty:0});
    reparto.st.push({name:b.name, qty:0});
  });
  persistState(); renderReparto();
}
function renderReparto(){
  const cont = byId('reparto_wrap'); cont.innerHTML='';
  ['sp','sl','st'].forEach(code=>{
    const card = document.createElement('div');
    card.className='card';
    const hd = document.createElement('div');
    hd.className='hd';
    hd.innerHTML = `<strong>${code.toUpperCase()}</strong>
      <div class="toolbar">
        <span class="hint">Solo aparecen productos comprados</span>
      </div>`;
    const bd = document.createElement('div');
    bd.className='bd';

    const list = reparto[code]||[];
    const purchasedSet = new Set(purchases.map(x=>normKey(x.name)));
    const filtered = list.filter(r=> purchasedSet.has(normKey(r.name)));

    if(!filtered.length){
      bd.innerHTML = '<div class="hint">Sin l√≠neas para repartir.</div>';
    }else{
      let html = '<div class="scroll-x"><table><thead><tr><th>Producto</th><th>Cantidad</th></tr></thead><tbody>';
      filtered.forEach((it,ix)=>{
        html += `<tr>
          <td contenteditable="true" data-code="${code}" data-idx="${ix}" data-f="name" class="green">${it.name}</td>
          <td contenteditable="true" data-code="${code}" data-idx="${ix}" data-f="qty" class="green">${it.qty}</td>
        </tr>`;
      });
      html += '</tbody></table></div>';
      bd.innerHTML = html;

      bd.querySelectorAll('td[contenteditable]').forEach(cell=>{
        const code2 = cell.dataset.code;
        const idx = Number(cell.dataset.idx);
        const f = cell.dataset.f;

        if(f==='name'){
          attachAutocomplete(cell, picked=>{
            cell.innerText = picked;
            reparto[code2][idx].name = picked;
            persistState();
          });
        }
        cell.addEventListener('blur', ()=>{
          const val = cell.innerText.trim();
          if(f==='qty'){
            reparto[code2][idx].qty = Number(String(val).replace(',','.'))||0;
          }else{
            reparto[code2][idx].name = removeDiacriticsUpper(val);
          }
          persistState();
          supaReplaceRepartoLocal();
        });
      });
    }

    card.appendChild(hd); card.appendChild(bd);
    cont.appendChild(card);
  });
}
async function supaReplaceRepartoLocal(){
  setSyncStatus('Guardando reparto...');
  const flat = [];
  ['sp','sl','st'].forEach(code=>{
    (reparto[code]||[]).forEach(r=>{
      if((Number(r.qty)||0)>0){
        flat.push({tienda:code, producto:r.name, cantidad:Number(r.qty)||0});
      }
    });
  });
  const ok = await supaReplaceReparto(flat);
  setSyncStatus(ok?'Reparto guardado':'Error reparto', !!ok);
}

/* ==========================
   Terminar Tarea (sync + limpiar)
========================== */
async function terminarTarea(){
  if(!confirm('Esto sincroniza tiendas, compras y reparto y luego limpia el dispositivo. ¬øContinuar?')) return;
  setSyncStatus('Finalizando tarea...');
  await supaReplaceStore('sp', tiendaState.sp||[]);
  await supaReplaceStore('sl', tiendaState.sl||[]);
  await supaReplaceStore('st', tiendaState.st||[]);
  await supaReplaceCompras(purchases||[]);
  const flat = [];
  ['sp','sl','st'].forEach(code=>{
    (reparto[code]||[]).forEach(r=>{ if((Number(r.qty)||0)>0) flat.push({tienda:code, producto:r.name, cantidad:Number(r.qty)||0}); });
  });
  await supaReplaceReparto(flat);
  localStorage.clear();
  setSyncStatus('Tarea finalizada. Datos limpiados.');
  alert('‚úÖ Tarea terminada. Todo sincronizado y datos locales limpiados.');
  location.reload();
}

/* ==========================
   INIT
========================== */
(async function init(){
  showTab('dic');
  loadState();
  ['sp','sl','st'].forEach(code=> renderTable(code));
  buildProvBar();
  renderProvidersPanels();
  unificarGlobal();
  renderCompras();
  renderReparto();

  try{
    setSyncStatus('Cargando desde Supabase...');
    const sv = await supaFetchVocab();
    if(sv && sv.length){
      const unique = uniqueVocab(sv);
      byId('vocabTxt').value = unique.join('\n');
      localStorage.setItem(LS.VOCAB, byId('vocabTxt').value);
    }else{
      byId('vocabTxt').value = uniqueVocab(toLines(OFFICIAL_VOCAB_RAW)).join('\n');
      localStorage.setItem(LS.VOCAB, byId('vocabTxt').value);
      await supaReplaceVocab(toLines(byId('vocabTxt').value));
    }

    const st = await supaFetchTiendas();
    if(st){
      const map = { sp:[], sl:[], st:[] };
      st.forEach(r=>{
        map[r.tienda]?.push({
          o: removeDiacriticsUpper(r.original||r.producto),
          e: removeDiacriticsUpper(r.producto),
          q: Number(r.cantidad)||0,
          a: (r.estado==='revisar')
        });
      });
      tiendaState.sp = map.sp; tiendaState.sl = map.sl; tiendaState.st = map.st;
      persistState();
      ['sp','sl','st'].forEach(code=> renderTable(code));
      unificarGlobal();
      renderProvidersPanels();
    }

    const comp = await supaFetchCompras();
    if(comp){
      purchases = comp.map(r=>({name:removeDiacriticsUpper(r.producto), qty:Number(r.cantidad)||0, prov: r.proveedor||''}));
      persistState(); renderCompras();
    }

    const rep = await supaFetchReparto();
    if(rep){
      reparto = {sp:[], sl:[], st:[]};
      rep.forEach(r=>{ if(reparto[r.tienda]) reparto[r.tienda].push({name:removeDiacriticsUpper(r.producto), qty:Number(r.cantidad)||0}); });
      persistState(); renderReparto();
    }

    setSyncStatus('Sincronizado');
  }catch(e){
    console.warn(e);
    setSyncStatus('Modo offline (no se pudo sincronizar)', false);
  }
})();
</script>
</body>
</html>
